#!/bin/sh
# vim: noet sw=8 sts=8 :

SYDBOX_MEMORY_ACCESS=${SYDBOX_MEMORY_ACCESS:-0}
if test -n "$SHOEBOX_PFC"; then
	opt_export=:${SHOEBOX_PFC}
else
	opt_export=
fi

eexec() {
	if test -n "$SYDBOX_STRACE_ENABLED"; then
		exec strace -ff -o "$SHOEBOX_STRACE" -- "$@"
	else
		exec "$@"
	fi
}

if test -z "$SYDBOX_TEST_INSTALLED"
then
	if test -z "$SYDBOX_DUMP_ENABLED"
	then
		eexec "@TOP_BUILDDIR@"/src/sydbox \
			-M ${SYDBOX_MEMORY_ACCESS} \
			-e pfc"${opt_export}" \
			$SYDBOX_TEST_OPTIONS "$@"
	else
		eexec "@TOP_BUILDDIR@"/src/sydbox-dump \
			-M ${SYDBOX_MEMORY_ACCESS} \
			-e pfc"${opt_export}" \
			$SYDBOX_TEST_OPTIONS "$@"
	fi
else
	if test -z "$SYDBOX_DUMP_ENABLED"
	then
		eexec "@BINDIR@"/sydbox \
			-M ${SYDBOX_MEMORY_ACCESS} \
			-e pfc"${opt_export}" \
			$SYDBOX_TEST_OPTIONS "$@"
	else
		eexec "@LIBEXECDIR@"/sydbox/dump/sydbox-dump \
			-M ${SYDBOX_MEMORY_ACCESS} \
			-e pfc"${opt_export}" \
			$SYDBOX_TEST_OPTIONS "$@"
	fi
fi
