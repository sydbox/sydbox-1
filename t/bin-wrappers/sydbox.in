#!/bin/sh

set -x
if test -n "$SYDBOX_DUMP_ENABLED" && -z "$SHOEBOX"
then
	i=1
	while true; do
		shoe=$(printf '%s.%02d' "$SHOEBOX" "$i")
		if test -f "$shoe"
		then
			i=$(expr "$i" + 1)
		else
			SHOEBOX="$shoe"
			export SHOEBOX
			break
		fi
	done
fi

SYDBOX_USE_MEMORY=${SYDBOX_USE_MEMORY:-0}
if test -z "$SYDBOX_TEST_INSTALLED"
then
	if test -z "$SYDBOX_DUMP_ENABLED"
	then
		exec "@TOP_BUILDDIR@"/src/sydbox \
			-M ${SYDBOX_USE_MEMORY} \
			$SYDBOX_TEST_OPTIONS "$@"
	else
		exec "@TOP_BUILDDIR@"/src/sydbox-dump \
			-M ${SYDBOX_USE_MEMORY} \
			$SYDBOX_TEST_OPTIONS "$@"
	fi
else
	if test -z "$SYDBOX_DUMP_ENABLED"
	then
		exec "@BINDIR@"/sydbox \
			-M ${SYDBOX_USE_MEMORY} \
			$SYDBOX_TEST_OPTIONS "$@"
	else
		exec "@LIBEXECDIR@"/sydbox/dump/sydbox-dump \
			-M ${SYDBOX_USE_MEMORY} \
			$SYDBOX_TEST_OPTIONS "$@"
	fi
fi
